from utils import *
from model import Popularity, UserKNN
from pymongo import MongoClient
import random
db = MongoClient().models

# for dataset in MongoClient().datasets["fs.files"].find():
#     if db["fs.files"].find({"dataset_id": dataset["_id"],
#                             "class": "UserKNN",
#                             "test_recall_100": {"$exists":True}
#                             }).count() == 0:
#         train, valid, test, exclude = load_dataset(dataset["_id"])
#         if db["fs.files"].find({"dataset_id": dataset["_id"]}).count() > 0:
#             record = list(db["fs.files"].find({"dataset_id": dataset["_id"]}))[0]
#             print record
#             model = UserKNN(record["n_users"], record["n_items"], 200)
#             model.train(train)
#             save(record["dataset"], model, record["n_users"], record["n_items"],
#                  train, valid, test, exclude, None, None, None, _id=record["dataset_id"])
#     #

# for record in db["fs.files"].find({"class": "LightFMModel"}):
#     model = load_model(record["_id"])[0]
#     record["with_features"] = model.V_features_orig is not None
#     print record["with_features"]
#     db["fs.files"].save(record)
#     print "Save" + str(model)
while True:
    try:
        records = db["fs.files"].find({"test_recall_100_95p_30000s": {"$exists":False},

                                       "_id": {"$in":
                                                   [2936048131225470862,
                                                    7985355249640947961,
                                                    3412398617062793771,
                                                    7926877197119037346,
                                                    4829015312935379579,
                                                    1538207488373570352,
                                                    -1880656802599393932,
                                                    1540982986844617825,
                                                    -8830286047823715170,
                                                    8032169371303254088,
                                                    -3585065358394263628,
                                                    3368774557012942775,
                                                    -701745142001855896,
                                                    3757292912151545849,
                                                    -5580056595943457555,
                                                    -7800332076702237358,
                                                    2346601646910011578,
                                                    -1837848417694193308,
                                                    9092219556296512022,
                                                    8379970193268270268,
                                                    1531338811507334376,
                                                    -5840628743107350927,
                                                    9021421049233424862,
                                                    8348016729655552085,
                                                    -6239261711900181299,
                                                    -6924803864913323761,
                                                    -251335928212709518,
                                                    6716140122397399647,
                                                    -4910528720528139738,
                                                    2552877104744523895,
                                                    4473852377534213465,
                                                    -3413493776679394572,
                                                    -7028935663915324534,
                                                    -5117217091099662370,
                                                    -4514965915855019105,
                                                    -6870315394862162723,
                                                    -4090475117303559011,
                                                    7186092471525358480,
                                                    2806190959102487375,
                                                    -8538943969636385630,
                                                    -6753042844249624171,
                                                    2954949490779159962,
                                                    6684849909643309472,
                                                    2731214765852353506,
                                                    3209316466862426059,
                                                    3128324430219450531,
                                                    -5557191341516509336,
                                                    -677120944264394412,
                                                    3871434674368471357,
                                                    -5766723640268471652,
                                                    -1330184076259559533,
                                                    -9107016336963970449,
                                                    -7818347426904081866,
                                                    -7252710068945175299,
                                                    -8383051608249090835,
                                                    -7196410386453000830,
                                                    -3547966209844006656,
                                                    6337514606406388975,
                                                    -8975409351891041831,
                                                    -266977000478983851,
                                                    8835249332757073777,
                                                    2472806673263499581,
                                                    -6260824840641569386,
                                                    6518577181186464746,
                                                    4636635312942996004,
                                                    5482930867748651516,
                                                    4297735652869641684,
                                                    1978115630190963301,
                                                    4536493793602325492,
                                                    -4628301353497570722,
                                                    1002031638344536794,
                                                    8162364929472444446,
                                                    2389223915628767514,
                                                    2385742206627447913,
                                                    -5627076332791093199,
                                                    8560492772916573840,
                                                    -6672191375769157810,
                                                    -3767825655922952479,
                                                    5648969254789034719,
                                                    7392755867656913699,
                                                    -4085158236110011637,
                                                    -998847665489352989,
                                                    -188919303455221408,
                                                    4434019857290849664,
                                                    -6425760564521799008,
                                                    3559845865130697561,
                                                    -3122848646590628750,
                                                    -2148629816562193406,
                                                    616282597203525670,
                                                    4086834770260017959,
                                                    -5407812687832705599,
                                                    -6303119507362106509,
                                                    -8418818630298044899,
                                                    1352375330236313303,
                                                    -6674105543508680440,
                                                    4897553002029964742,
                                                    2555559890983899977,
                                                    5061537450437342293,
                                                    6217472712540135861,
                                                    -7402463773975596579,
                                                    -6847242372680792284,
                                                    2627275408154754656,
                                                    -7629517226456837874,
                                                    -3195446459950145227,
                                                    1771933032492821707,
                                                    -5734531796512145287,
                                                    3474066032554430762,
                                                    -2275105200429561392,
                                                    4536545879026272129,
                                                    4983764759617874322,
                                                    1572779407190432046,
                                                    8465662813578776809,
                                                    -2023828097500397969,
                                                    -2226797502256097092,
                                                    3478314394500964467,
                                                    -7200008017288040514,
                                                    -186135345635798014,
                                                    -6630098247766976922,
                                                    -1438456719658488636,
                                                    -3861132006974422077,
                                                    -1677242192380687614,
                                                    -3419847204039821509,
                                                    4924442826440239901,
                                                    583204333455294594,
                                                    7015033485233529326,
                                                    -2147242993236344560,
                                                    2666306241605748754,
                                                    -2669420438995352026,
                                                    -1504753686771103198,
                                                    8652954716147329419]
                                               }
                                     })
        if records.count() > 0:
            record = records[random.randint(0, records.count()-1)]
            eval_one_for_cold_items(record["_id"])
    except Exception as e:
        print e

